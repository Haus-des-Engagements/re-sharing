#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset


python /app/manage.py collectstatic --noinput
python /app/manage.py migrate

# Start the default queue worker with auto-restart
(
  while true; do
    echo "[$(date)] Starting db_worker for default queue..."
    python /app/manage.py db_worker --queue-name default || echo "[$(date)] WARNING: default db_worker crashed with exit code $?, restarting in 5s..."
    sleep 5
  done
) &

# Start the email queue worker with auto-restart
(
  while true; do
    echo "[$(date)] Starting db_worker for email queue..."
    python /app/manage.py db_worker --queue-name email || echo "[$(date)] WARNING: email db_worker crashed with exit code $?, restarting in 5s..."
    sleep 5
  done
) &

exec gunicorn config.wsgi --bind 0.0.0.0:5000 --chdir=/app
