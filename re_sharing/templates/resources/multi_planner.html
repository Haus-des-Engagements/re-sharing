{% extends "base.html" %}

{% load static i18n %}

{% block title %}
  {% trans "Find a free room" %}
{% endblock title %}
{% block content %}
  <h1 class="mt-4">{% trans "Find a free room" %}</h1>
  <div class="mt-3 mb-4">
    <p>
      {% trans "In this view, you can see the free times for all resources. Click on a free (white) slot to go directly to the booking page." %}
    </p>
  </div>
  {% if locations.count > 1 %}
    <div class="alert alert-info" role="alert">
      <p>{% trans "We provide rooms at different locations, please select accordingly:" %}</p>
      <form id="locations"
            hx-get="{% url 'resources:planner' %}"
            hx-target="#selection_and_table"
            hx-indicator="#spinner"
            hx-headers='{"partial": "selection_and_table"}'
            hx-push-url="true"
            hx-swap="innerHTML"
            hx-trigger="change">
        <div class="col-auto" id="div_id_location">
          <label for="id_location" class="form-label visually-hidden">{% trans "Location" %}</label>
          <select name="location"
                  class="select form-select form-select"
                  id="id_location">
            <option value="">{% trans "All locations" %}</option>
            {% for location in locations %}
              <option value="{{ location.slug }}"
                      {% if location.slug == location_slug %}selected{% endif %}>
                {{ location.name }} ({{ location.address }})
              </option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
  {% endif %}
  <div id="selection_and_table" class="mt-4 mb-3">
    {% partialdef selection-and-table inline %}
    <form id="resources"
          hx-get="{% url 'resources:planner' %}"
          hx-target="#planner-table"
          hx-indicator="#spinner"
          hx-headers='{"partial": "planner-table"}'
          hx-push-url="true"
          hx-swap="innerHTML"
          hx-trigger="change"
          hx-sync="closest form:replace">
      <div class="row g-4">
        {% for access, resources in grouped_resources.items %}
          <div class="col-auto ms-2">
            {{ access }}:
            {% for resource in resources %}
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       id="resource-{{ resource.slug }}"
                       name="resources"
                       value="{{ resource.slug }}"
                       {% if resource in selected_resources %}checked{% endif %} />
                <label for="resource-{{ resource.slug }}" class="form-check-label">{{ resource.name }}</label>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
      <div class="row g-2 mt-4 justify-content-between">
        <div class="row g-2 col-auto">
          <div id="div_date" class="col-auto">
            <label for="date" class="form-label visually-hidden">{% trans "Date" %}</label>
            <input type="date"
                   name="date"
                   class="form-control textinput form-control"
                   placeholder="{% trans 'Date' %}"
                   id="date"
                   value="{{ dates.shown_date|date:'Y-m-d' }}" />
          </div>
          <div class="col-auto" id="div_id_selected_nb_of_days">
            <label for="id_selected_nb_of_days" class="form-label visually-hidden">{% trans "Days to display" %}</label>
            <select name="selected_nb_of_days"
                    class="select form-select form-select"
                    id="id_selected_nb_of_days">
              {% for number in nb_of_days %}
                <option value={{ number }} {% if number == selected_nb_of_days %}selected{% endif %}>{{ number }} {% trans "days" %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div id="spinner"
               class="spinner-border col-auto htmx-indicator d-flex align-self-center ms-4"
               role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div class="col-auto hstack gap-3">
          <div class="p-2 border small bookable">{% trans "bookable" %}</div>
          <div class="p-2 border small restricted">{% trans "restricted" %}</div>
          <div class="p-2 border small booked">{% trans "booked" %}</div>
          {% if request.user.is_authenticated %}
            <div class="p-2 border small booked-by-me">{% trans "booked by me" %}</div>
          {% endif %}
          <div class="p-2 border small past">{% trans "past" %}</div>
        </div>
      </div>
    </form>
    <div id="planner-table" class="row g-2 d-flex mt-1">
      {% partialdef multi-planner-table inline %}
      <div class="table-responsive">
        <!-- Iterate through each weekday group -->
        {% for day, day_data in planner_data.items %}
          <table class="table table-sm table-sm-little-padding mb-0 table-bordered border-secondary small">
            <thead>
              <tr class="table-light">
                <th>{{ day|date:"l, d.m.y" }}</th>
                {% for timeslot in day_data.resources.0.timeslots %}
                  {% if not forloop.counter|divisibleby:2 %}<th colspan="2">{{ timeslot.time|date:"H:i" }}</th>{% endif %}
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <!-- Iterate through resources -->
              {% for resource in day_data.resources %}
                <tr class="w-25">
                  <td class="table-light w-25 text-truncate">
                    {{ resource.name }}
                    <a href="{% url 'resources:show-resource' resource_slug=resource.slug %}">
                      <svg class="fs-4 me-1" width="1em" height="1em">
                        <use href="#bi-link" />
                      </svg>
                    </a>
                  </td>
                  {% for timeslot in resource.timeslots %}
                    {% if timeslot.status == "booked" %}
                      <td class="table-booked" title="{{ timeslot.organization }}">
                        {% if timeslot.link %}
                          <a href="{{ timeslot.link }}" class="cover-link">&nbsp</a>
                        {% else %}
                          &nbsp
                        {% endif %}
                      </td>
                    {% elif timeslot.status == "booked by me" %}
                      <td class="table-booked-by-me"
                          title="{{ timeslot.organization }} - {{ timeslot.title }}">
                        <a href="{{ timeslot.link }}" class="cover-link">&nbsp</a>
                      </td>
                    {% elif timeslot.status == "restricted" %}
                      <td class="table-restricted" title="{{ timeslot.restriction_message }}">
                        <a href="{% url 'bookings:create-booking' %}{{ timeslot.link }}"
                           class="cover-link">&nbsp
                          <span class="visually-hidden">Restricted booking on {{ timeslot.time|date:"d.m.y H:i" }}</span></a>
                      </td>
                    {% elif timeslot.status == "bookable" %}
                      <td class="table-light">
                        <a href="{% url 'bookings:create-booking' %}{{ timeslot.link }}"
                           class="cover-link">&nbsp
                          <span class="visually-hidden">Book resource on {{ timeslot.time|date:"d.m.y H:i" }}</span></a>
                      </td>
                    {% elif timeslot.status == "past" %}
                      <td class="table-past">
                        &nbsp
                        <span class="visually-hidden">past</span>
                      </td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      </div>
    {% endpartialdef %}
  </div>
{% endpartialdef %}
</div>
{% endblock content %}
