{% extends "base.html" %}

{% load i18n %}
{% load static %}
{% load tz %}
{% load crispy_forms_tags %}

{% block content %}
  <h1 class="mt-4">
    {% trans "Manage bookings" %}
    <a class="btn btn-outline-primary"
       href="{% url 'bookings:create-booking' %}"
       role="button">
      <svg width="1em" height="1em">
        <use href="#bi-plus-lg" />
      </svg>
      {% trans "New Booking" %}
    </a>
  </h1>
  <form class="row gx-3 gy-2 align-items-center mt-3"
        method="get"
        hx-get="{% url 'bookings:manager-list-bookings' %}"
        hx-target="#booking-list"
        hx-trigger="change"
        hx-indicator="#spinner"
        hx-push-url="true"
        hx-sync="closest form:replace">
    <div id="div_id_organization" class="col-3">
      <select name="organization" class="form-select" id="id_organization">
        <option value="all"
                {% if selected_organization == "all" %}selected{% endif %}>{% trans "all organizations" %}</option>
        {% for organization in organizations %}
          <option value="{{ organization.slug }}"
                  {% if selected_organization == organization.slug %}selected{% endif %}>{{ organization }}</option>
        {% endfor %}
      </select>
    </div>
    {% if locations.count > 1 %}
      <div id="div_id_location" class="col-auto">
        <select name="location" class="form-select" id="id_location">
          <option value="all" {% if selected_location == "all" %}selected{% endif %}>{% trans "all locations" %}</option>
          {% for location in locations %}
            <option value="{{ location.slug }}"
                    {% if selected_location == location.slug %}selected{% endif %}>{{ location }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}
    <div id="div_id_resource" class="col-auto">
      <select name="resource" class="form-select" id="id_resource">
        <option value="all" {% if selected_resource == "all" %}selected{% endif %}>{% trans "all resources" %}</option>
        {% for resource in resources %}
          <option value="{{ resource.slug }}"
                  {% if selected_resource == resource.slug %}selected{% endif %}>{{ resource }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto" id="div_id_status">
      <select name="status" class="select form-select" id="id_status">
        <option value="all" {% if selected_status == "all" %}selected{% endif %}>{% trans "all statuses" %}</option>
        {% for status in statuses %}
          <option value="{{ status.0 }}"
                  {% if selected_status|stringformat:"s" == status.0|stringformat:"s" %}selected{% endif %}>
            {{ status.1 }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <input type="date"
             name="from_date"
             class="form-control textinput"
             id="id_from_date"
             placeholder="{% trans 'From date' %}"
             {% if selected_from_date %}value="{{ selected_from_date }}"{% endif %} />
    </div>
    <div class="col-auto">
      <input type="date"
             name="until_date"
             class="form-control textinput"
             id="id_until_date"
             placeholder="{% trans 'Until date' %}"
             {% if selected_until_date %}value="{{ selected_until_date }}"{% endif %} />
    </div>
    <div class="col-auto form-check">
      <input type="checkbox"
             name="show_past_bookings"
             class="form-check-input"
             id="id_show_past_bookings"
             {% if show_past_bookings %}checked{% endif %} />
      <label for="id_show_past_bookings" class="form-check-label">{% trans "show past bookings" %}</label>
    </div>
    <div class="col-auto form-check">
      <input type="checkbox"
             name="show_recurring_bookings"
             class="form-check-input"
             id="id_hide_recurring_bookings"
             {% if show_recurring_bookings %}checked{% endif %} />
      <label for="id_show_recurring_bookings" class="form-check-label">
        {% trans "show" %} <a href="{% url 'bookings:manager-list-booking_series' %}">{% trans "booking series" %}</a>
      </label>
    </div>
    <div id="spinner"
         class="spinner-border col-auto htmx-indicator"
         role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </form>
  <div id="booking-list">
    {% partialdef manager-list-bookings inline %}
    <div class="table-responsive mt-5">
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">{% trans "Created" %}</th>
            <th scope="col">{% trans "Booking" %}</th>
            <th scope="col">{% trans "Timespan" %}</th>
            <th scope="col">{% trans "Resource" %}</th>
            <th scope="col">{% trans "Organization" %}</th>
            <th scope="col">{% trans "Title" %}</th>
            <th scope="col">{% trans "Status" %}</th>
            <th scope="col"></th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
            <tr id="tr-{{ booking.slug }}">
              {% partialdef manager-booking-item inline %}
              <td>{{ booking.created|date:"d.m.Y H:i" }}</td>
              <td>{{ booking.timespan.lower|date:"D, d.m.Y" }}</td>
              <td>{{ booking.timespan.lower|date:"H:i" }} - {{ booking.timespan.upper|date:"H:i" }}</td>
              <td>{{ booking.resource }}</td>
              <td>
                <a href="{% url "organizations:show-organization" booking.organization.slug %}">{{ booking.organization }}</a>
              </td>
              <td>
                <a href="{% url "bookings:show-booking" booking.slug %}">{{ booking.title }}</a>
              </td>
              <td>
                <span class="fs-6 badge text-bg-status-{{ booking.status }}">{{ booking.get_status_display }}</span>
              </td>
              <td>
                {% if booking.is_confirmable %}
                  <button id="confirm-button"
                          type="submit"
                          class="btn btn-sm btn-outline-success"
                          value="Submit"
                          hx-patch="{% url 'bookings:manager-confirm-booking' booking_slug=booking.slug %}"
                          hx-target="#tr-{{ booking.slug }}"
                          hx-swap="innerHTML">{% trans "Confirm" %}</button>
                {% endif %}
              </td>
              <td>
                {% if booking.is_cancelable %}
                  <button id="cancel-button"
                          type="submit"
                          class="btn btn-sm btn-outline-danger"
                          value="Submit"
                          hx-confirm="{% trans 'Are you sure you want to cancel this booking?' %}"
                          hx-patch="{% url 'bookings:manager-cancel-booking' booking_slug=booking.slug %}"
                          hx-target="#tr-{{ booking.slug }}"
                          hx-swap="innerHTML">{% trans "Cancel" %}</button>
                {% endif %}
              </td>
            {% endpartialdef %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endpartialdef %}
</div>
{% endblock content %}
