{% extends "base.html" %}

{% load i18n %}
{% load static %}
{% load tz %}
{% load crispy_forms_tags %}

{% block content %}
  <h1 class="mt-4">
    {% trans "Manage organizations" %}
    <a class="btn btn-outline-primary"
       href="{% url 'organizations:create-organization' %}"
       role="button">
      <svg width="1em" height="1em">
        <use href="#bi-plus-lg" />
      </svg>
      {% trans "New Organization" %}
    </a>
  </h1>
  <form class="row gx-3 gy-2 align-items-center mt-3"
        action="{% url 'organizations:manager-list-organizations' %}"
        method="get"
        hx-get="{% url 'organizations:manager-list-organizations' %}"
        hx-target="#organization-list"
        hx-trigger="input changed delay:300ms, keyup, change"
        hx-indicator="#spinner"
        hx-push-url="true">
    <div class="col-auto">
      <input type="text"
             name="search"
             class="form-control"
             placeholder="{% trans 'Search organizations...' %}" />
    </div>
    <div class="col-auto" id="div_id_status">
      <select name="status" class="select form-select" id="id_status">
        <option value="all" selected>{% trans "all statuses" %}</option>
        {% for status in statuses %}<option value="{{ status.0 }}">{{ status.1 }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-auto" id="div_id_group">
      <select name="group" class="select form-select" id="id_group">
        <option value="all">{% trans "all groups" %}</option>
        {% for group in groups %}<option value="{{ group.slug }}">{{ group.name }}</option>{% endfor %}
      </select>
    </div>
    <div id="spinner"
         class="spinner-border col-auto htmx-indicator"
         role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </form>
  <div id="organization-list">
    {% partialdef organization-list inline %}
    <div class="table-responsive mt-5">
      <table class="table table-hover sortable" id="organizations-table">
        <thead>
          <tr>
            <th scope="col">{% trans "Created" %}</th>
            <th scope="col">{% trans "Name" %}</th>
            <th scope="col">{% trans "Status" %}</th>
            <th scope="col">{% trans "Bookings" %}</th>
            <th scope="col">{% trans "Agreement" %}</th>
            <th scope="col">{% trans "Organization groups" %}</th>
            <th scope="col">{% trans "Permanent Code" %}</th>
            <th scope="col"></th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
          {% for organization in organizations %}
            <tr id="tr-{{ organization.slug }}">{% partial organization-item %}</tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
        var newTableObject = document.getElementById("organizations-table")
        sorttable.makeSortable(newTableObject);
      </script>
    </div>
  {% endpartialdef %}
</div>
{% endblock content %}
{% partialdef organization-item %}
<td sorttable_customkey="{{ organization.created|date:"YmdHi" }}">{{ organization.created|date:"d.m.Y" }}</td>
<td>
  <!-- djlint:off --><span class="d-inline-block text-truncate" style="max-width: 300px;"><!-- djlint:on -->
  <a href="{% url "organizations:show-organization" organization.slug %}">{{ organization.name }}</a>
</span>
</td>
<td>
  <div class="dropdown">
    <button class="btn btn-secondary btn-sm dropdown-toggle text-bg-status-{{ organization.status }}"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false">{{ organization.get_status_display }}</button>
    <ul class="dropdown-menu">
      {% if organization.is_cancelable %}
        <li>
          <a href="#"
             id="cancel-button"
             class="dropdown-item"
             type="submit"
             value="Submit"
             hx-confirm="{% trans 'Are you sure you want to cancel this organization?' %}"
             hx-patch="{% url 'organizations:manager-cancel-organization' organization_slug=organization.slug %}"
             hx-target="#tr-{{ organization.slug }}"
             hx-swap="innerHTML">{% trans "Cancel" %}</a>
        </li>
      {% endif %}
      {% if organization.is_confirmable %}
        <li>
          <a href="#"
             id="confirm-button"
             type="submit"
             class="dropdown-item"
             value="Submit"
             hx-patch="{% url 'organizations:manager-confirm-organization' organization_slug=organization.slug %}"
             hx-target="#tr-{{ organization.slug }}"
             hx-swap="innerHTML">{% trans "Confirm" %}</a>
        </li>
      {% endif %}
    </ul>
  </div>
</td>
<td>
  <a href="{% url "bookings:manager-list-bookings" %}?organization_search={{ organization.name }}&show_past_bookings=on&show_recurring_bookings=on&status=all">{{ organization.bookings_count }}</a>
</td>
<td sorttable_customkey="{{ organization.usage_agreement_date|date:"Ymd" }}">
  {% if organization.usage_agreement %}
    <a href="{{ organization.usage_agreement.url }}">{{ organization.usage_agreement_date|default_if_none:_("without date") }}</a>
  {% else %}
    {% trans "n.a." %}
  {% endif %}
</td>
<td>{{ organization.organization_groups.all|join:", " }}</td>
<td>
  <div class="dropdown">
    <button class="btn btn-secondary btn-sm dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false">
      {% if organization.active_codes %}
        {% for code in organization.active_codes %}
          <code class="text-white">
            {{ code.code }}
            {% if code.validity_end %}({{ code.validity_end|date:"d.m.Y" }}){% endif %}
          </code>
          {% if not forloop.last %}<br />{% endif %}
        {% endfor %}
      {% else %}
        {% trans "No code" %}
      {% endif %}
    </button>
    <ul class="dropdown-menu">
      {% if not organization.active_codes %}
        {# Create action - only show when no code exists #}
        <li>
          <a href="#"
             class="dropdown-item"
             hx-post="{% url 'organizations:manager-permanent-code-action' organization_slug=organization.slug %}"
             hx-vals='{"action": "create"}'
             hx-target="#tr-{{ organization.slug }}"
             hx-swap="innerHTML"
             hx-confirm="{% trans 'Create a new permanent code for this organization?' %}">
            <svg width="1em" height="1em" class="me-1">
              <use href="#bi-plus-lg" />
            </svg>
            {% trans "Create Code" %}
          </a>
        </li>
      {% else %}
        {# Invalidate and Renew actions - show for each active code #}
        {% for code in organization.active_codes %}
          <li>
            <h6 class="dropdown-header">
              <code>{{ code.code }}</code>
            </h6>
          </li>
          <li>
            <a href="#"
               class="dropdown-item"
               data-bs-toggle="modal"
               data-bs-target="#invalidateModal-{{ organization.slug }}-{{ code.id }}">
              <svg width="1em" height="1em" class="me-1">
                <use href="#bi-x-circle" />
              </svg>
              {% trans "Invalidate" %}
            </a>
          </li>
          <li>
            <a href="#"
               class="dropdown-item"
               hx-post="{% url 'organizations:manager-permanent-code-action' organization_slug=organization.slug %}"
               hx-vals='{"action": "renew", "permanent_code_id": "{{ code.id }}"}'
               hx-target="#tr-{{ organization.slug }}"
               hx-swap="innerHTML"
               hx-confirm="{% trans 'Renew the permanent code? The old code will remain valid for 1 week.' %}">
              <svg width="1em" height="1em" class="me-1">
                <use href="#bi-arrow-repeat" />
              </svg>
              {% trans "Renew" %}
            </a>
          </li>
          {% if not forloop.last %}
            <li>
              <hr class="dropdown-divider" />
            </li>
          {% endif %}
        {% endfor %}
      {% endif %}
    </ul>
  </div>
  {# Modals for Invalidate action - one per code #}
  {% for code in organization.active_codes %}
    <div class="modal fade"
         id="invalidateModal-{{ organization.slug }}-{{ code.id }}"
         tabindex="-1"
         aria-labelledby="invalidateModalLabel-{{ organization.slug }}-{{ code.id }}"
         aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"
                id="invalidateModalLabel-{{ organization.slug }}-{{ code.id }}">
              {% trans "Invalidate Permanent Code" %} <code>{{ code.code }}</code>
            </h5>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="invalidateForm-{{ organization.slug }}-{{ code.id }}">
              <div class="mb-3">
                <label for="validity_end-{{ organization.slug }}-{{ code.id }}"
                       class="form-label">{% trans "Code will become invalid at:" %}</label>
                <input type="datetime-local"
                       class="form-control"
                       id="validity_end-{{ organization.slug }}-{{ code.id }}"
                       name="validity_end"
                       required />
                <div class="form-text">{% trans "Leave empty to invalidate immediately" %}</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
            <button type="button"
                    class="btn btn-danger"
                    hx-post="{% url 'organizations:manager-permanent-code-action' organization_slug=organization.slug %}"
                    hx-vals='js:{"action": "invalidate", "permanent_code_id": "{{ code.id }}", "validity_end": document.getElementById("validity_end-{{ organization.slug }}-{{ code.id }}").value}'
                    hx-target="#tr-{{ organization.slug }}"
                    hx-swap="innerHTML"
                    data-bs-dismiss="modal">{% trans "Invalidate" %}</button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</td>
{% endpartialdef %}
